<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"
	charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>ê²¬ê°•í• ê³ ì–‘</title>
<script type="text/javascript"
	src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=v02baxm8gp"></script>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
<link href="/css/style.css" rel="stylesheet">
<link href="/css/reserv_form.css" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&display=swap"
	rel="stylesheet">
</head>
<body class="d-flex flex-column h-100">
	<img style="display: none" id="mainGif" src="/images/loading.gif">
	<div th:replace="~{user/header :: header}"></div>
	<div class="container-xl">
		<h1 class="mt-3 mt-md-5 mb-3 mb-md-3">ë™ë¬¼ë³‘ì› ì˜ˆì•½ ë“±ë¡</h1>
		<div class="mt-3 item"><div>ë™ë¬¼ë³‘ì›</div><input type="text" id="vetName" disabled></div>
		<div class="mt-3 item"><div>ë‚ ì§œ*</div><input type="date" name="reserv_date"></div>
		<div class="mt-3 item">
			<div>ìˆ˜ì˜ì‚¬ ì„ íƒ*</div>
			<select id="vet" class="form-select" aria-label="Default select example">
			  <option value="default" selected>ì›í•˜ëŠ” ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
			</select>
		</div>
		<div class="mt-3 item">
			<div>ì‹œê°„ ì„ íƒ*</div>
			<div id="time_slot">
			</div>
		</div>
		<div class="mt-3 item"><div>ë³´í˜¸ì</div><input type="text" value="ë¡œê·¸ì¸í•œíšŒì›ì´ë¦„" disabled></div>
		<div class="mt-3 item">
			<div>ë°˜ë ¤ë™ë¬¼ ì„ íƒ*</div>
			<select id="pet" class="form-select" aria-label="Default select example">
			  <option selecte value="">ì§„ë£Œë³´ê¸¸ ì›í•˜ëŠ” ë°˜ë ¤ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
			</select>
		</div>
		<div class="mt-3 item">
			<div>ì§„ë£Œìœ í˜•*</div>
			<select id="type" class="form-select" aria-label="Default select example">
			  <option selected value="">ì§„ë£Œìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
			  <option value="ì¼ë°˜ì§„ë£Œ">ì¼ë°˜ì§„ë£Œ</option>
			  <option value="ê±´ê°•ê²€ì§„">ê±´ê°•ê²€ì§„</option>
			  <option value="ì˜ˆë°©ì ‘ì¢…">ì˜ˆë°©ì ‘ì¢…</option>
			  <option value="ìŠ¤ì¼€ì¼ë§">ìŠ¤ì¼€ì¼ë§</option>
			</select>
		</div>
		<div class="mt-3 item"><div>ë©”ëª¨</div><textarea type="text" name="memo"></textarea></div>
		<div class="mt-3 item">
			<div>ì¿ í°ì‚¬ìš©</div>
			<select id="coupon" class="form-select" aria-label="Default select example">
			  <option selected>ì¿ í°ì‚¬ìš© ì•ˆí•¨</option>
			</select>
		</div>
		<div class="mt-3 item">
		<div><span>í¬ì¸íŠ¸ ì‚¬ìš©</span><span>&nbsp &nbsp â€» 1000 í¬ì¸íŠ¸ ë‹¨ìœ„ë¡œ ì‚¬ìš© ê°€ëŠ¥</span><span> &nbsp&nbsp ë³´ìœ í¬ì¸íŠ¸ <span id="point"></span>P</span></div>
		<input type="text" name="points_used" placeholder="0">
		</div>
		<input class="btn btn-main" onclick=" return submitForm(event)" type="button" value="ì˜ˆì•½ë“±ë¡">
		<button class="btn btn-user-sub" onclick="">ë¬¸ì˜ì±„íŒ…</button>
	</div>
	<div th:replace="~{user/footer :: footer}"></div>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>
<script th:inline="javascript" type="text/javascript" src="/js/reserv_form.js"></script>

<script th:inline="javascript">
let hosId = "[[${id}]]";
let today = new Date();
let selectedDate;
//0:ì¼, 1:ì›”, 2:í™” .... 6:í† 
let selectedDay;
let selectedVet;
let selectedTime;
let selectedSlot = null; 
const date = document.querySelector("input[type=date]");
const vet = document.querySelector("#vet");
const timeSlot = document.querySelector("#time_slot");


function setDateLimit(){
	//ì˜¤ëŠ˜ ë‚ ì§œë³´ë‹¤ ì´ì „ ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ë„ë¡  
	date.setAttribute("min", today.toISOString().substring(0,10))
	//max ë‚ ì§œëŠ” 3ê°œì›” ì˜¤ëŠ˜ ë‚ ì§œ ì „ì¼
	today.setMonth(today.getMonth()+2)
	date.setAttribute("max", today.toISOString().substring(0,10))
}
setDateLimit();


date.addEventListener("change", function(e){
	if(selectedVet != null){
		selectedVet="";
		vet.value= "default";
		document.querySelector("#time_slot").innerHTML="";
	}
	selectedDate = e.target.value
	selectedDay = new Date(selectedDate).getDay();
})



const xhttp = new XMLHttpRequest();
xhttp.onload = function() {
	let data = JSON.parse(this.responseText);
	let userInfo = data[0];
	let vetAvailInfo = data[1];
	let vetInfo = data[2];
	let vetNamesNIds = Object.keys(vetAvailInfo);
	let basicHours = JSON.parse(vetInfo[Object.keys(vetInfo)[0]].businessHours);
	let basicHoursArr = getBasicBusinessHours(basicHours);
	console.log(data)
  //ë³‘ì› ì´ë¦„ ë„£ê¸°
  document.querySelector("#vetName").setAttribute("value", Object.keys(vetInfo)[0]);
  //í¬ì¸íŠ¸ì •ë³´ë„£ê¸°
  document.querySelector("#point").innerHTML = userInfo.pointList[0];
  //ì¿ í° ì •ë³´ ë„£ê¸°
  for(let i = 0; i < userInfo.couponList.length; i++){
	  let coupon = userInfo.couponList[i];
	  let listItem = document.createElement("option");
	  listItem.setAttribute("value", coupon.id);
	  listItem.innerHTML = coupon.name + ', ë°œí–‰ë‚ ì§œ' + formattingDate(coupon.issueDate) + ', ë§Œë£Œë‚ ì§œ' + formattingDate(coupon.expiryDate);
	  document.querySelector("#coupon").appendChild(listItem);
  }
  //ë°˜ë ¤ë™ë¬¼ì •ë³´ë„£ê¸°
  for(let i = 0; i < userInfo.petList.length; i++){
	  let pet = userInfo.petList[i];
	  let listItem = document.createElement("option");
	  listItem.setAttribute("value", pet.id);
	  listItem.innerHTML = pet.name + '';
	  document.querySelector("#pet").appendChild(listItem);
  }
  //ìˆ˜ì˜ì‚¬ì •ë³´ë„£ê¸°
  for(let i = 0; i < vetNamesNIds.length; i++){
	  console.log(vetNamesNIds[i])
	  let vet = vetNamesNIds[i].split("//")
	  let vetName = vet[1];
	  let vetId = vet[0];
	
	  let listItem = document.createElement("option");
	  listItem.setAttribute("value", vetId);
	  listItem.innerHTML = vetName + ' ìˆ˜ì˜ì‚¬ ì„ ìƒë‹˜';
	  document.querySelector("#vet").appendChild(listItem);
  }
  
//ì‹œê°„ ë¿Œë ¤ì£¼ê¸°(ì˜ì‚¬, ë‚ ì§œ ë¥¼ ì„ íƒí•˜ëŠ” ìˆœê°„ ê·¸ì— ë§ì¶°ì„œ ì‹œê°„ ë°”ê¿”ì£¼ê¸°)
// //ê¸°ë³¸ì ìœ¼ë¡œ ì˜ì—…ì‹œê°„ì— ê¸°ì¤€í•´ì„œ ì‹œê°„ ë¿Œë ¤ì£¼ê¸°

  vet.addEventListener("change", function(e){
	  document.querySelector("#time_slot").innerHTML="";
		selectedVet = e.target.value
// 		console.log(selectedVet)
// 		console.log(selectedDate)
		if(selectedDate == null){
			alert("ì§„ë£Œ ì˜ˆì•½ì„ ì›í•˜ëŠ” ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!")
		}
		
		//í•´ë‹¹ë‚ ì§œ ê¸°ë³¸ íƒ€ì„ìŠ¬ë¡¯ë³´ì—¬ì£¼ê¸°
		if(basicHoursArr[selectedDay] !=null){
			let selectedBasicTime = basicHoursArr[selectedDay]["day"]
			showDates(selectedBasicTime[0], selectedBasicTime[1], selectedBasicTime[2], selectedBasicTime[3])
			//í•´ë‹¹ë‚ ì§œ í•´ë‹¹ì„ ìƒë‹˜ì˜ availabilityë³´ì—¬ì£¼ê¸°
			console.log(Object.keys(vetAvailInfo))
			Object.keys(vetAvailInfo).forEach(key=>{
				if(key.split("//")[0] == selectedVet){
					for(v of vetAvailInfo[key]){
						if(convertToTimeZone(v.date, 'Asia/Seoul') == selectedDate){
							console.log(v.time.slice(0,5))
							document.querySelector("span[value='"+v.time.slice(0,5)+"']").classList.add("disabled");
						}
					}
				}
			})
		}
	})
}
xhttp.open("GET", "http://localhost:9001/api/v1/user/reservation?id="+hosId, true);
xhttp.setRequestHeader("username", 1);
xhttp.send();

function formattingDate(date){
	let newDate = date.slice(0,10);
	return newDate;
}


function convertingDate(basicHours, day){
	let startTime;
	let endingTime;
	let lunchStart;
	let lunchEnd;
	//ì˜ì—…í•˜ëŠ” ë‚  ì‹œê°„ êµ¬í•˜ê¸°
	if(basicHours[day][0].slice(7) !="ì˜ì—… ì•ˆí•¨"){
		startTime = basicHours[day][0].slice(7).split("//")[0];
		endingTime = basicHours[day][0].slice(7).split("//")[1];
		//ì˜ì—…í•˜ë©´ì„œ&ì ì‹¬ì‹œê°„ìˆìŒ
		if(basicHours[day][1].slice(7) !="ì ì‹¬ì‹œê°„ ì—†ìŒ"){
			lunchStart = basicHours[day][1].slice(7).split("//")[0];
			lunchEnd = basicHours["mon"][1].slice(7).split("//")[1];
		}else{
			//ì˜ì—…í•˜ì§€ë§Œ&ì ì‹¬ì‹œê°„ì—†ìŒ
			lunchStart = 0;
			lunchEnd = 0;
		}
	}else{
		//ì˜ì—… ì•ˆ í•˜ëŠ” ë‚ 
		startTime = 0;
		endingTime = 0;
		lunchStart = 0;
		lunchEnd = 0;
	}
	return {day : [startTime, endingTime, lunchStart, lunchEnd]};
}

function showDates(startTime, endTime, lunchStart, lunchEnd){
	if(startTime == 0|| endTime == 0 || lunchStart == 0 ||lunchEnd == 0){
		document.querySelector("#time_slot").innerHTML="<div class='msg'>í•´ë‹¹ì¼ì€ ì˜ˆì•½ê°€ëŠ¥í•œ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤ğŸ¥²</div>"
		return;
	}
    // ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
    let [startHour, startMinute] = startTime.split(":").map(Number);
    let [endHour, endMinute] = endTime.split(":").map(Number);
    let [lunchStartHour, lunchStartMinute] = lunchStart.split(":").map(Number);
    let [lunchEndHour, lunchEndMinute] = lunchEnd.split(":").map(Number);
    
    let startTotalMinutes = startHour * 60 + startMinute;
    let endTotalMinutes = endHour * 60 + endMinute;
    let lunchStartTotalMinutes = lunchStartHour * 60 + lunchStartMinute;
    let lunchEndTotalMinutes = lunchEndHour * 60 + lunchEndMinute;
    
    // 30ë¶„ ê°„ê²©ìœ¼ë¡œ ë²„íŠ¼ ìƒì„±
    let currentMinutes = startTotalMinutes;
    while (currentMinutes < endTotalMinutes) {
        let hours = Math.floor(currentMinutes / 60);
        let minutes = currentMinutes % 60;
        
        let timeString = String(hours).padStart(2, '0') + ":" + String(minutes).padStart(2, '0');
        let listItem = document.createElement("span");
        listItem.setAttribute("value", timeString);
        listItem.classList = "time_slot"
        listItem.innerHTML = timeString;
        document.querySelector("#time_slot").appendChild(listItem);
        currentMinutes += 30;
        
        if (currentMinutes > lunchStartTotalMinutes && currentMinutes <= lunchEndTotalMinutes) {
            listItem.classList.add("disabled");
        } else {
            listItem.addEventListener("click", function() {
                // click ì´ë²¤íŠ¸ í•¸ë“¤ë§
                console.log("ì˜ˆì•½ ì‹œê°„: " + timeString);
            });
        }
        listItem.addEventListener("click", function(e) {
        	//clickì´ë²¤íŠ¸ í•¸ë“¤ë§
            console.log("ì˜ˆì•½ ì‹œê°„: " + timeString);
        	selectedTime = timeString;
        	if (selectedSlot) {
                selectedSlot.style.backgroundColor = ""; 
            }
            e.target.style.backgroundColor = "#4C5CB3";
            
            selectedSlot = e.target;
        });
    }
}

function getBasicBusinessHours(basicHours){
	let sun = convertingDate(basicHours, "sun");
	let mon = convertingDate(basicHours, "mon");
	let tue = convertingDate(basicHours, "tue");
	let wed = convertingDate(basicHours, "wed");
	let thu = convertingDate(basicHours, "thu");
	let fri = convertingDate(basicHours, "fri");
	let sat = convertingDate(basicHours, "sat");
	let hol = convertingDate(basicHours, "hol");
	return [sun, mon, tue, wed, thu, fri, sat];
}

function convertToTimeZone(date, timeZone) {
    // ì‹œê°„ëŒ€ë¥¼ ë³€í™˜í•œ ë‚ ì§œë¥¼ ìƒì„±
    const dateInTimeZone = new Date(date.toLocaleString('en-US', { timeZone }));

    // ë…„, ì›”, ì¼ì„ ê°€ì ¸ì˜´
    const year = dateInTimeZone.getFullYear();
    const month = String(dateInTimeZone.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•¨
    const day = String(dateInTimeZone.getDate()).padStart(2, '0');

    // yyyy-MM-dd í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
    return year+"-"+ month+"-"+day;
}

function submitForm(e){
	e.preventDefault();
	let formData = {
		"hospitalId": hosId,
		"doctorId": selectedVet,
		"date" : document.querySelector("input[type=date]").value,
		"time" : selectedTime,
		"pet" : document.querySelector("#pet").value,
		"type": document.querySelector("#type").value,
		"memo": document.querySelector("textarea").value,
		"coupon" : document.querySelector("#coupon").value,
		"point":document.querySelector("input[name=points_used]").value,
	}
	if(selectedVet == null || document.querySelector("input[type=date]").value == null 
			|| selectedTime == null || document.querySelector("#pet").value == ""
			|| document.querySelector("#type").value == ""){
		alert("í•„ìˆ˜ ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”");
		return false;
	}
	console.log(formData)
	
	 const xhttp = new XMLHttpRequest();
	  xhttp.onload = function() {
	    //ë‹¤ë¥¸í˜ì´ì§€ë¡œ ì´ë™?ã…ã…,,
	    alert("ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
	    location.href="/"
	    }
	  xhttp.open("POST", "http://localhost:9001/api/v1/user/reservation", true);
	  xhttp.setRequestHeader("username", 1);
	  xhttp.setRequestHeader("Content-type", "application/json");
	  xhttp.send(JSON.stringify(formData));
}
</script>



</body>

</html>