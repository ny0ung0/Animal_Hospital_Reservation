<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"
	charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>ê²¬ê°•í• ê³ ì–‘</title>
<script type="text/javascript"
	src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=v02baxm8gp"></script>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
<link href="/css/style.css" rel="stylesheet">
<link href="/css/vet_detail.css" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&display=swap"
	rel="stylesheet">
</head>
<body class="d-flex flex-column h-100">
	<img style="display: none" id="mainGif" src="/images/loading.gif">
	<div th:replace="~{user/header :: header}"></div>
	<div class="container-xl">
		<h1 class="mt-3 mt-md-5 mb-3 mb-md-3">ë™ë¬¼ë³‘ì› ìƒì„¸í˜ì´ì§€</h1>
		<div class="row">
			<div class="d-flex align-items-center">
			<h1 id="vet_name"></h1>
			<img style="width:50px;" onclick="checkBookmark(event)" id="bookmarkImg" src="/images/bookmark.png">
			<div id="hospital_id" style="display:none;">ë²ˆí˜¸</div>
			</div>
		<div class="col-md-6">
			<div class="img_container" style="max-width:300px; margin:50px auto;"><img class="w-100" id="logo" src=""  alt="ë¡œê³ "/></div>
		</div>
		<div class="col-md-6">
	        <div class='item'><span class="modal-sub-title">ë²ˆí˜¸</span><span id="phone">ë²ˆí˜¸</span></div>
	        <div class='item'><span class="modal-sub-title">ì£¼ì†Œ</span><span id="address">ì£¼ì†Œ</span></div>
	        <div class='modal-memVetInfo'>
	          <div class='item'><span class="modal-sub-title">ì˜ì—…ì‹œê°„</span><span id="working_hour" >ì˜ì—…ì‹œê°„</span></div>
	          
	          <div class='item'><img style="width:35px; transform: rotate(-20deg);" src="/images/pin_p.svg"><span class="modal-sub-title">í¬ì¸íŠ¸ì œíœ´ì—¬ë¶€</span><span id="point" >í¬ì¸íŠ¸ì œíœ´ì—¬ë¶€</span></div>
	          <div class='item'><span class="modal-sub-title">ë³‘ì›ì†Œê°œ</span><span id="introduction" >ë³‘ì›ì†Œê°œ</span></div>
         	</div>
        </div>
         	
	          <div class='item'>
	            <span class="modal-sub-title">í‰ê· ë³„ì </span>
	            <div class="reviewContainer">
	              <div id='review_overview'>
		              <span id="avgReview">í‰ê· ë³„ì </span>
		              <span id="reviewStars"></span>
		              <span id="reviewCount">ë¦¬ë·° ê°œìˆ˜</span>
		              <div id="reviewDistribution">
		                <!-- ë¦¬ë·° ë¶„í¬ ê·¸ë˜í”„ -->
		              </div>
	              <a id="toggleReviews" >ë¦¬ë·° ë³´ê¸°</a>
	              </div>
	              <div id="reviewList">
	                <div id="review"></div>
	              </div>
	            </div>
	          </div>
	          <div class='item'>
		          <div><span class="modal-sub-title">ëŒ€í‘œìì´ë¦„</span><span id="representative" >ëŒ€í‘œìì´ë¦„</span></div>
		          <div><span class="modal-sub-title">ì´ë©”ì¼</span><span id="email">ì´ë©”ì¼</span></div>
		          <div><span class="modal-sub-title">ì‚¬ì—…ìë²ˆí˜¸</span><span id="businessNumber">ì‚¬ì—…ìë²ˆí˜¸</span></div>
	          </div>
	          <div class="row">
	            <div class="col-6 p-1">
	              <button style="width: 100%;" class="btn btn-user-sub reservationBtn" onclick="makeReservation(event)">ì˜ˆì•½í•˜ê¸°</button>
	            </div>
	            <div class="col-6 p-1">
	              <button style="width: 100%;" class="btn btn-hospital-sub chatBtn" onclick="chat(event)">ë¬¸ì˜ì±„íŒ…</button>
	            </div>
	          </div>
	        </div>
		</div>
	</div>
	
	
	<div th:replace="~{user/footer :: footer}"></div>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>
	<script type="text/javascript" src="/js/modal.js"></script>
	<script>
		const id = "[[${id}]]";
		console.log(id)
		document.querySelector("#hospital_id").setAttribute("data-id", id);
		const xhttp = new XMLHttpRequest();
		  xhttp.onload = function() {
			  responseCheck(this);
			  let data = JSON.parse(this.responseText)
		      console.log(data);
			  document.querySelector("#vet_name").innerText = data.hospitalName;
		 	  document.querySelector("#phone").innerHTML = data.phone;
		 	  document.querySelector("#address").innerHTML = data.address.replaceAll("//", " ");
 			  let basicHours = JSON.parse(data.businessHours);
 			  
	 			// ì˜ì—…ì‹œê°„ ì„¤ì •
	 			showBusinessHour(basicHours);
	 			// í¬ì¸íŠ¸ì œíœ´ì—¬ë¶€ ì„¤ì •
	 			document.querySelector("#point").innerHTML = data.partnership ? "í¬ì¸íŠ¸ì œíœ´ë³‘ì› â­•" : "í¬ì¸íŠ¸ì œíœ´ë³‘ì› âŒ";
	 			// ë¶ë§ˆí¬ ì„¤ì •
	 			document.querySelector("#bookmarkImg").src = data.bookmarked ? "/images/bookmark_fill.png" : "/images/bookmark.png"; 
	 			// ì‚¬ì—…ìë²ˆí˜¸ ì„¤ì •
	 			document.querySelector("#businessNumber").innerHTML = data.businessNumber;
	 			// ì´ë©”ì¼ ì„¤ì •
	 			document.querySelector("#email").innerHTML= data.email;
	 			// ì†Œê°œê¸€ ì„¤ì •
	 			document.querySelector("#introduction").innerHTML = data.introduction;
	 			if(data.logo != null){
	 				// ë¡œê³  ì„¤ì •
	 				document.querySelector("#logo").src = "/images/user/" + data.logo;
	 			}
	 			// ëŒ€í‘œì ì„¤ì •
	 			document.querySelector("#representative").innerHTML = data.representative;
				
	 			// ë¦¬ë·° ì„¤ì •
	 			// 1. í‰ê· ë³„ì  ì„¤ì •
	 			document.querySelector("#avgReview").innerHTML = data.avgReview ? 
	 					data.avgReview + "/5" + repeatCharacters("â­", data.avgReview) :
	 			    "<span style=\"font-size: 18px; font-family: 'Jua', sans-serif; font-weight: normal;\">ì•„ì§ ë³„ì ì´ ì—†ì–´ìš”ğŸ˜… <br> ì˜ˆì•½ í›„, ì²« ë³„ì ì„ ë‚¨ê²¨ë³´ì„¸ìš” :)</span>";

	 		    const hasReviews = data.review.length > 0;
			
	 		    if (hasReviews) {
	 		      document.querySelector("#reviewCount").innerText = "ë¦¬ë·° " + data.review.length + "ê°œ";
	 		      document.querySelector("#toggleReviews").style.display = "block";
	 		      document.querySelector("#reviewList").style.display = "none"; // ì´ˆê¸° ìƒíƒœëŠ” ìˆ¨ê¹€
			
	 		      // 3. ë¦¬ë·° ë¶„í¬ ê·¸ë˜í”„ ì„¤ì •
	 		      let reviewDistributionHTML = '';
	 		      const reviewCounts = [0, 0, 0, 0, 0]; // 5ì ë¶€í„° 1ì ê¹Œì§€ì˜ ë¦¬ë·° ê°œìˆ˜
	 		      const maxReviewCount = data.review.length || 1; // ìµœëŒ€ ë¦¬ë·° ê°œìˆ˜
			
	 		     data.review.forEach(function(review) {
	 		        reviewCounts[review.rating - 1]++;
	 		      });
			
	 		      for (let i = 4; i >= 0; i--) {
	 		        const barWidth = (reviewCounts[i] / maxReviewCount) * 100 + "%";
	 		        reviewDistributionHTML += 
	 		          "<div class='review-bar'><span>" + (i + 1) + "ì :</span>" + 
	 		          "<div style='width:" + barWidth + ";'></div>" + 
	 		          "</div>";
	 		      }
			
	 		      document.querySelector("#reviewDistribution").innerHTML = reviewDistributionHTML;
			
	 		      // 4. ë¦¬ë·° ë¿Œë ¤ì£¼ê¸°
	 		      data.review.forEach(function(review) {
	 		        let listItem = document.createElement("div");
	 		        listItem.classList = "review-item";
	 		        listItem.innerHTML = 
	 		          "<span>" + review.review + "</span>" +
	 		          "<span><div>" + review.type + "</div> || <div>" + review.doctor.name + " ìˆ˜ì˜ì‚¬</div> || " +
	 		         review.updatedAt[0] + "-" + review.updatedAt[1] + "-" + review.updatedAt[2] + "</span>";
	 		        document.querySelector("#review").appendChild(listItem);
	 		      });
			
	 		      // ë¦¬ë·° ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
	 		      document.querySelector("#toggleReviews").onclick = function() {
	 		        const reviewList = document.querySelector("#reviewList");
	 		        if (reviewList.style.display === "none") {
	 		          reviewList.style.display = "block";
	 		          this.innerText = "ë¦¬ë·° ìˆ¨ê¸°ê¸°";
	 		        } else {
	 		          reviewList.style.display = "none";
	 		          this.innerText = "ë¦¬ë·° ë³´ê¸°";
	 		        }
	 		      };
	 		    } else {
	 		      document.querySelector("#reviewCount").innerText = "";
	 		      document.querySelector("#reviewDistribution").style.display = "none";
	 		      document.querySelector("#toggleReviews").style.display = "none";
	 		    }
		    }
		  xhttp.open("GET", "http://localhost:9001/api/v1/user/vet-detail?id=" + id, true);
		  xhttp.setRequestHeader("MemberId", localStorage.getItem("MemberId"));
		  xhttp.setRequestHeader("Authorization", localStorage.getItem("token"));
		  xhttp.setRequestHeader("role", localStorage.getItem("role"));
		  xhttp.send();
		
		

	</script>

</body>

</html>