<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>견강할고양</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/reserv_schedule.css">
</head>

<body class="d-flex flex-column h-100">
    <div th:replace="~{hospital/header :: header}"></div>
    <div class="container-xl">
        <h1 class="mt-3 mt-md-5 mb-3 mb-md-3">진료 일정 관리</h1>
        <hr />
        <input type="hidden" id="doctorId" th:value="${doctorId}">
        <input type="hidden" id="selectedDate" th:value="${date}">
        <h4 class="fw-bold mb-3">[[${doctorName}]] 수의사 진료일정([[${date}]])</h4>
        <div class="border p-4 rounded">
            <div class="container container-600">
                <input type="checkbox" class="btn-check" id="btn-check-1" data-time="00:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-1">00:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-2" data-time="00:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-2">00:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-3" data-time="01:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-3">01:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-4" data-time="01:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-4">01:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-5" data-time="02:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-5">02:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-6" data-time="02:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-6">02:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-7" data-time="03:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-7">03:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-8" data-time="03:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-8">03:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-9" data-time="04:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-9">04:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-10" data-time="04:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-10">04:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-11" data-time="05:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-11">05:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-12" data-time="05:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-12">05:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-13" data-time="06:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-13">06:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-14" data-time="06:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-14">06:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-15" data-time="07:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-15">07:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-16" data-time="07:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-16">07:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-17" data-time="08:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-17">08:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-18" data-time="08:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-18">08:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-19" data-time="09:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-19">09:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-20" data-time="09:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-20">09:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-21" data-time="10:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-21">10:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-22" data-time="10:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-22">10:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-23" data-time="11:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-23">11:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-24" data-time="11:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-24">11:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-25" data-time="12:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-25">12:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-26" data-time="12:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-26">12:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-27" data-time="13:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-27">13:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-28" data-time="13:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-28">13:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-29" data-time="14:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-29">14:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-30" data-time="14:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-30">14:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-31" data-time="15:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-31">15:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-32" data-time="15:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-32">15:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-33" data-time="16:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-33">16:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-34" data-time="16:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-34">16:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-35" data-time="17:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-35">17:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-36" data-time="17:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-36">17:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-37" data-time="18:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-37">18:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-38" data-time="18:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-38">18:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-39" data-time="19:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-39">19:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-40" data-time="19:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-40">19:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-41" data-time="20:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-41">20:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-42" data-time="20:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-42">20:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-43" data-time="21:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-43">21:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-44" data-time="21:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-44">21:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-45" data-time="22:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-45">22:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-46" data-time="22:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-46">22:30</label>
                <input type="checkbox" class="btn-check" id="btn-check-47" data-time="23:00" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-47">23:00</label>
                <input type="checkbox" class="btn-check" id="btn-check-48" data-time="23:30" autocomplete="off"
                    checked="false">
                <label class="btn btn-light mb-2 mx-1" for="btn-check-48">23:30</label>
            </div>
        </div>
        <div class="clear-fix mt-3">
            <button class="btn btn-hospital-sub float-end" data-bs-toggle="modal"
                data-bs-target="#unavailableTimeComment">저장하기</button>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="unavailableTimeComment" tabindex="-1"
            aria-labelledby="unavailableTimeCommentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title fs-5" id="unavailableTimeCommentModalLabel">진료 불가 사유</h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="unavailableTimeCommentInput" class="form-control"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-hospital-sub" onclick="saveUnavailableTime()">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="~{hospital/footer :: footer}"></div>
    <script type="text/javascript">
    const selectedDate = document.querySelector("#selectedDate").value;
    const doctorId = document.querySelector("#doctorId").value;
    const memberId = localStorage.getItem("MemberId");
    const token = localStorage.getItem("token");
    document.addEventListener('DOMContentLoaded', function () {
       

        let reservationTime = [];
        let unavailableTime = [];
        let lunchHours, lunchStart, lunchEnd, start, end;

        // 예약 불가능한 시간 데이터 가져오기
        fetch("http://localhost:9001/api/v1/hospital/doctor/unavailable-time/" + doctorId, {
            method: "GET",
            headers: {
                'Authorization': `${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
        	//console.log("data ", data);
            data.forEach(unavTime => {
            	
                // 서버에서 받은 UTC 시간을 Date 객체로 변환
		        const utcDate = new Date(unavTime.date);
               // console.log("utcDate", utcDate);
		        
		        // UTC 시간을 로컬 시간대로 변환
		        const localDate = new Date(utcDate.getTime() - new Date().getTimezoneOffset() * 60000);
		        //console.log("localDate", localDate);
		        
		        // 로컬 날짜를 ISO 포맷의 문자열로 변환하여 날짜 부분만 추출
		        const unavDate = localDate.toISOString().split('T')[0];
		        
		        console.log("unavDate ", unavDate);
                if (unavDate === selectedDate) {
                    unavailableTime.push(unavTime.time.slice(0, 5));
                }
            });
            console.log("unavailableTime", unavailableTime);
            updateCheckboxes();
        })
        .catch(error => console.log(error));

        // 예약된 시간 데이터 가져오기
        fetch("http://localhost:9001/api/v1/hospital/reservation/doctor/" + doctorId, {
            method: "GET",
            headers: {
                'Authorization': `${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
        	
            data.forEach(reserve => {
            	console.log(reserve.reservationDatetime);
            	console.log(reserve.reservationDatetime[1].toString().length);
            	let dateIndex1 = "";
            	if(reserve.reservationDatetime[1].toString().length === 1){
            		dateIndex1 = "0" + reserve.reservationDatetime[1];
            	}else{
            		dateIndex1 = reserve.reservationDatetime[1];
            	}
            	
            	let dateIndex4 = "";
            	if(reserve.reservationDatetime[4].toString().length === 1){
            		dateIndex4 = reserve.reservationDatetime[4] + "0";
            	}else{
            		dateIndex4 = reserve.reservationDatetime[4];
            	}
            	
            	let newDate = reserve.reservationDatetime[0] + "-" + dateIndex1 + "-" + reserve.reservationDatetime[2];
            	let newTime = reserve.reservationDatetime[3] + ":" + dateIndex4;
            	console.log(newDate);
            	console.log(newTime);
                if (newDate.startsWith(selectedDate)) {
                	
                    reservationTime.push(newTime.slice(0, 5));
                    
                }
            });
            console.log(reservationTime);
            updateCheckboxesSelectNone();
        })
        .catch(error => console.log(error));

        // 영업 시간 데이터 가져오기
        fetch("http://localhost:9001/api/v1/hospital/business-hours", {
            method: "GET",
            headers: {
                'Authorization': `${token}`,
                'memberId': memberId
            }
        })
        .then(response => response.json())
        .then(data => {
            const dayOfWeek = new Date(selectedDate).getDay();
            const dayOfWeekStr = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"][dayOfWeek];
            const newBusinessHoursData = data[dayOfWeekStr];

            if (newBusinessHoursData) {
                const openingHours = newBusinessHoursData[0].split(" : ")[1].trim();
                lunchHours = newBusinessHoursData[1].split(" : ")[1].trim();

                if (lunchHours.startsWith("점심시간 없음")) {
                    console.log("점심시간 없음!");
                } else {
                    lunchStart = timeToMinutes(lunchHours.split("//")[0].trim());
                    lunchEnd = timeToMinutes(lunchHours.split("//")[1].trim());
                }
                start = timeToMinutes(openingHours.split("//")[0].trim());
                end = timeToMinutes(openingHours.split("//")[1].trim());

                // 페이지 로드 시 시간대 선택 가능 여부 설정
                updateCheckboxesNone();

            } else {
                console.error('Error: newBusinessHoursData is null or undefined');
            }
        })
        .catch(error => console.error('Error fetching business hours:', error));

        function isTimeSelectable(time) {
            const currentTime = timeToMinutes(time);
            if (currentTime === -1) {
                return false;
            }

            if (lunchHours !== "점심시간 없음" && currentTime >= lunchStart && currentTime < lunchEnd) {
                return false;
            }

            const timeInterval = 30;
            if ((currentTime - start) % timeInterval !== 0) {
                return false;
            }

            if (currentTime < start || currentTime >= end) {
                return false;
            }

            return true;
        }

        function timeToMinutes(time) {
            if (!time || typeof time !== 'string') {
                return -1;
            }
            const parts = time.split(":");
            if (parts.length !== 2) {
                return -1;
            }
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            if (isNaN(hours) || isNaN(minutes)) {
                return -1;
            }
            return hours * 60 + minutes;
        }

        function updateCheckboxes() {
            const checkboxes = document.querySelectorAll('.btn-check');
            
            checkboxes.forEach(checkbox => {
            	const timeStr = checkbox.dataset.time; // 체크박스의 data-time 속성 값 가져오기 (예: "08:00")
                const [hour, minute] = timeStr.split(':').map(num => parseInt(num)); // 시간 문자열을 시간과 분으로 분리하고 숫자로 변환
                
                // unavailableTime 배열에서 해당 시간과 분이 포함되어 있는지 검사
                const isUnavailable = unavailableTime.some(([unavHour, unavMinute]) => {
                    return hour === unavHour && minute === unavMinute;
                });

                checkbox.checked = isUnavailable; // 체크박스의 체크 상태를 예약 불가능 시간 여부에 따라 설정
            });
        }

        function updateCheckboxesNone() {
            const checkboxes = document.querySelectorAll('.btn-check');
            checkboxes.forEach(checkbox => {
                const time = checkbox.dataset.time;
                if (!isTimeSelectable(time)) {
                    checkbox.style.display = "none";
                    const labelId = checkbox.id.replace('btn-check-', '');
                    const label = document.querySelector(`label[for="btn-check-${labelId}"]`);
                    if (label) {
                        label.style.display = "none";
                    }
                }
            });
        }

        // 예약된 시간 체크 함수
        function isTimeSelectableReservation(time) {
            const currentTimeReservation = timeToMinutes(time);
            return !reservationTime.includes(time);
        }

        function updateCheckboxesSelectNone() {
            const checkboxes = document.querySelectorAll('.btn-check');
            checkboxes.forEach(checkbox => {
                const time = checkbox.dataset.time;
                if (!isTimeSelectableReservation(time)) {
                    checkbox.disabled = true;
                    const labelId = checkbox.id.replace('btn-check-', '');
                    const label = document.querySelector(`label[for="btn-check-${labelId}"]`);
                    if (label) {
                        label.style.color = 'gray';
                    }
                }
            });
        }

        function saveUnavailableTime() {
            const unavailableTimeComment = document.querySelector("#unavailableTimeCommentInput").value;
            const checkedTimes = [];
            const checkedElements = document.querySelectorAll(".btn-check:checked");

            checkedElements.forEach(element => {
                const time = element.dataset.time;
                checkedTimes.push(time);
            });

            console.log("unavailableTimeComment " + unavailableTimeComment);
            const timeData = {
                comment: unavailableTimeComment,
                date: selectedDate,
                time: checkedTimes,
                doctorId: doctorId,
                hospitalId: memberId,
            }
            // 객체를 json으로 변경하기
            const sendData = JSON.stringify(timeData);
            console.log(sendData);
            fetch("http://localhost:9001/api/v1/hospital/doctor/unavailable-time", {
                method: "POST",
                headers: {
                    'Authorization': `${token}`,
                    "Content-type": "application/json"
                },
                body: sendData
            })
            .then(response => response.text())
            .then(data => {
                console.log(data);
            })
            .catch(error => console.log(error));
        }
    });

    function saveUnavailableTime() {
        const unavailableTimeComment = document.querySelector("#unavailableTimeCommentInput").value;
        const checkedTimes = [];
        const checkedElements = document.querySelectorAll(".btn-check:checked");

        checkedElements.forEach(element => {
            const time = element.dataset.time;
            checkedTimes.push(time);
        });

        console.log("unavailableTimeComment " + unavailableTimeComment);
        const timeData = {
            comment: unavailableTimeComment,
            date: selectedDate,
            time: checkedTimes,
            doctorId: doctorId,
            hospitalId: memberId,
        }
        // 객체를 json으로 변경하기
        const sendData = JSON.stringify(timeData);
        console.log(sendData);
        fetch("http://localhost:9001/api/v1/hospital/doctor/unavailable-time", {
            method: "POST",
            headers: {
                'Authorization': `${token}`,
                "Content-type": "application/json"
            },
            body: sendData
        })
            .then(response => response.text())
            .then(data => {
                console.log(data);
                location.reload();

            })
            .catch(error => console.log(error));

    }
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>